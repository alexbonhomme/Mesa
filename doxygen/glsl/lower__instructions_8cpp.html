<html>
<head>
<title>Mesa Source Code Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="qindex">
<a class="qindex" href="../main/index.html">core</a> |
<a class="qindex" href="../glapi/index.html">glapi</a> |
<a class="qindex" href="../glsl/index.html">glsl</a> |
<a class="qindex" href="../vbo/index.html">vbo</a> |
<a class="qindex" href="../math/index.html">math</a> |
<a class="qindex" href="../shader/index.html">shader</a> |
<a class="qindex" href="../swrast/index.html">swrast</a> |
<a class="qindex" href="../swrast_setup/index.html">swrast_setup</a> |
<a class="qindex" href="../tnl/index.html">tnl</a> |
<a class="qindex" href="../tnl_dd/index.html">tnl_dd</a> |
<a class="qindex" href="../gbm/index.html">gbm</a>
</div>
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_9d873dbfec6053c8a46a8bdca18df976.html">glsl</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">lower_instructions.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Many GPUs lack native instructions for certain expression operations, and must replace them with some other expression tree.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;main/core.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="glsl__types_8h.html">glsl_types.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ir_8h.html">ir.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ir__builder_8h.html">ir_builder.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ir__optimization_8h.html">ir_optimization.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for lower_instructions.cpp:</div>
<div class="dyncontent">
<div class="center"><img src="lower__instructions_8cpp__incl.png" border="0" usemap="#lower__instructions_8cpp" alt=""/></div>
<map name="lower__instructions_8cpp" id="lower__instructions_8cpp">
<area shape="rect" id="node5" href="glsl__types_8h.html" title="glsl_types.h" alt="" coords="22,229,113,256"/><area shape="rect" id="node13" href="ir_8h.html" title="ir.h" alt="" coords="283,155,323,181"/><area shape="rect" id="node40" href="ir__builder_8h.html" title="ir_builder.h" alt="" coords="260,80,345,107"/><area shape="rect" id="node43" href="ir__optimization_8h.html" title="Prototypes for optimization passes to be called by the compiler and drivers." alt="" coords="369,80,487,107"/><area shape="rect" id="node19" href="ralloc_8h.html" title="ralloc: a recursive memory allocator" alt="" coords="475,304,539,331"/><area shape="rect" id="node30" href="list_8h.html" title="Doubly&#45;linked list abstract container type." alt="" coords="277,229,328,256"/><area shape="rect" id="node35" href="ir__visitor_8h.html" title="ir_visitor.h" alt="" coords="352,229,435,256"/><area shape="rect" id="node37" href="ir__hierarchical__visitor_8h.html" title="ir_hierarchical_visitor.h" alt="" coords="459,229,613,256"/></map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlower__instructions__visitor.html">lower_instructions_visitor</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lower__instructions_8cpp.html#a077773d9cfaed46d14070f8d0c4eb1a8">lowering</a>(x)&#160;&#160;&#160;(this-&gt;lower &amp; x)</td></tr>
<tr class="memdesc:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Determine if a particular type of lowering should occur.  <a href="#a077773d9cfaed46d14070f8d0c4eb1a8">More...</a><br/></td></tr>
<tr class="separator:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a609742f45a0fc3f1f96f435972707aca"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lower__instructions_8cpp.html#a609742f45a0fc3f1f96f435972707aca">lower_instructions</a> (<a class="el" href="structexec__list.html">exec_list</a> *instructions, unsigned what_to_lower)</td></tr>
<tr class="separator:a609742f45a0fc3f1f96f435972707aca"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Many GPUs lack native instructions for certain expression operations, and must replace them with some other expression tree. </p>
<p>This pass lowers some of the most common cases, allowing the lowering code to be implemented once rather than in each driver backend.</p>
<p>Currently supported transformations:</p>
<ul>
<li>SUB_TO_ADD_NEG</li>
<li>DIV_TO_MUL_RCP</li>
<li>INT_DIV_TO_MUL_RCP</li>
<li>EXP_TO_EXP2</li>
<li>POW_TO_EXP2</li>
<li>LOG_TO_LOG2</li>
<li>MOD_TO_FRACT</li>
<li>LRP_TO_ARITH</li>
<li>BITFIELD_INSERT_TO_BFM_BFI</li>
</ul>
<h2>SUB_TO_ADD_NEG:</h2>
<p>Breaks an ir_binop_sub expression down to add(op0, neg(op1))</p>
<p>This simplifies expression reassociation, and for many backends there is no subtract operation separate from adding the negation. For backends with native subtract operations, they will probably want to recognize add(op0, neg(op1)) or the other way around to produce a subtract anyway.</p>
<h2>DIV_TO_MUL_RCP and INT_DIV_TO_MUL_RCP:</h2>
<p>Breaks an ir_binop_div expression down to op0 * (rcp(op1)).</p>
<p>Many GPUs don't have a divide instruction (945 and 965 included), but they do have an RCP instruction to compute an approximate reciprocal. By breaking the operation down, constant reciprocals can get constant folded.</p>
<p>DIV_TO_MUL_RCP only lowers floating point division; INT_DIV_TO_MUL_RCP handles the integer case, converting to and from floating point so that RCP is possible.</p>
<h2>EXP_TO_EXP2 and LOG_TO_LOG2:</h2>
<p>Many GPUs don't have a base e log or exponent instruction, but they do have base 2 versions, so this pass converts exp and log to exp2 and log2 operations.</p>
<h2>POW_TO_EXP2:</h2>
<p>Many older GPUs don't have an x**y instruction. For these GPUs, convert x**y to 2**(y * log2(x)).</p>
<h2>MOD_TO_FRACT:</h2>
<p>Breaks an ir_binop_mod expression down to (op1 * fract(op0 / op1))</p>
<p>Many GPUs don't have a MOD instruction (945 and 965 included), and if we have to break it down like this anyway, it gives an opportunity to do things like constant fold the (1.0 / op1) easily.</p>
<h2>LRP_TO_ARITH:</h2>
<p>Converts ir_triop_lrp to (op0 * (1.0f - op2)) + (op1 * op2).</p>
<h2>BITFIELD_INSERT_TO_BFM_BFI:</h2>
<p>Breaks ir_quadop_bitfield_insert into ir_binop_bfm (bitfield mask) and ir_triop_bfi (bitfield insert).</p>
<p>Many GPUs implement the bitfieldInsert() built-in from ARB_gpu_shader_5 with a pair of instructions. </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="a077773d9cfaed46d14070f8d0c4eb1a8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define lowering</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td>&#160;&#160;&#160;(this-&gt;lower &amp; x)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Determine if a particular type of lowering should occur. </p>

<p>Referenced by <a class="el" href="classlower__instructions__visitor.html#a28dc28cb76fc9a33f660369ad51202ef">lower_instructions_visitor::visit_leave()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a609742f45a0fc3f1f96f435972707aca"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool lower_instructions </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structexec__list.html">exec_list</a> *&#160;</td>
          <td class="paramname"><em>instructions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>what_to_lower</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>References <a class="el" href="classlower__instructions__visitor.html#a570b47a743d9bd26ff1c8a93c89fad5f">lower_instructions_visitor::progress</a>, and <a class="el" href="ir__hierarchical__visitor_8h.html#a3d916e3fe1319c5d975084a1c412aa37">visit_list_elements()</a>.</p>

<p>Referenced by <a class="el" href="ir__optimization_8h.html#a225eedb7a8fad75e2a6e05212b7f70ce">do_common_optimization()</a>, and <a class="el" href="test__optpass_8cpp.html#a8a19eefda8984dbd5d14e58acb3c3189">do_optimization()</a>.</p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="lower__instructions_8cpp_a609742f45a0fc3f1f96f435972707aca_cgraph.png" border="0" usemap="#lower__instructions_8cpp_a609742f45a0fc3f1f96f435972707aca_cgraph" alt=""/></div>
<map name="lower__instructions_8cpp_a609742f45a0fc3f1f96f435972707aca_cgraph" id="lower__instructions_8cpp_a609742f45a0fc3f1f96f435972707aca_cgraph">
<area shape="rect" id="node3" href="ir__hierarchical__visitor_8h.html#a3d916e3fe1319c5d975084a1c412aa37" title="Process a list of nodes using a hierarchical vistor." alt="" coords="181,5,312,32"/><area shape="rect" id="node5" href="classir__instruction.html#aa797356958ce35850f057499c48a572c" title="ir_instruction::accept" alt="" coords="361,5,503,32"/></map>
</div>
</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
